<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycompany.healthcare.dao.ReceiptAndOpinionsDao">
	<insert id="insertReceipt" >
		insert into receipt_and_opinions
		(receipt_state, patient_id)
		values
		('대기', #{patient_id})
	</insert>

 	<select id="selectAllReceipt" resultType="receiptAndOpinions">
 		select p.patient_id, p.patient_name, p.patient_sex, p.patient_phone, 
 		 		rao.receipt_id, rao.receipt_state, rao.receipt_datetime
		from receipt_and_opinions rao, patients p
		where rao.patient_id = p.patient_id and rao.receipt_state != '완료'
	</select>
	
	<delete id="deleteReceiptById">
		delete from receipt_and_opinions
		where receipt_id = #{receipt_id}
	</delete>
	
	<update id="updateReceipt">
		update receipt_and_opinions
		set receipt_state = #{nextState}
		where receipt_id = #{receipt_id}
	</update>
	
	<select id="selectSearchPatientIdOpinionList" resultType="receiptAndOpinions">
		select receipt_id, date_format(receipt_datetime, '%Y-%m-%d') as receipt_datetime, receipt_state, diagnostic_test_state, receipt_opinion, receipt_uniqueness, patient_id
		from receipt_and_opinions
		where patient_id = #{patient_id}
	</select>
	
	<select id="selectSearchDateOpinionList" resultType="receiptAndOpinions">
		select receipt_id, date_format(receipt_datetime, '%Y-%m-%d') as receipt_datetime, receipt_state, diagnostic_test_state, receipt_opinion, receipt_uniqueness, patient_id
		from receipt_and_opinions
		where receipt_datetime Like CONCAT('%', #{receipt_datetime}, '%')
	</select>
	
	<select id="selectSearchPatientNameOpinionList" resultType="receiptAndOpinions">
		select r.receipt_id, date_format(receipt_datetime, '%Y-%m-%d') as receipt_datetime, r.receipt_state, r.diagnostic_test_state, r.receipt_opinion, r.receipt_uniqueness, r.patient_id
		from receipt_and_opinions r, patients p
		where r.patient_id = p.patient_id and p.patient_name = #{patient_name}
	</select>
	
	<select id="selectSearchPatientIdAndDateList"  resultType="receiptAndOpinions">
		select receipt_id, date_format(receipt_datetime, '%Y-%m-%d') as receipt_datetime, receipt_state, diagnostic_test_state, receipt_opinion, receipt_uniqueness, patient_id
		from receipt_and_opinions
		where receipt_datetime Like CONCAT('%', #{receipt_datetime}, '%') and patient_id = #{patient_id}
	</select>
	
	<select id="selectSearchPatientIdAndNameList"  resultType="receiptAndOpinions">
		select r.receipt_id, date_format(receipt_datetime, '%Y-%m-%d') as receipt_datetime, r.receipt_state, r.diagnostic_test_state, r.receipt_opinion, r.receipt_uniqueness, r.patient_id
		from receipt_and_opinions r, patients p
		where r.patient_id = p.patient_id and p.patient_name = #{patient_name} and r.patient_id = #{patient_id}
	</select>
	
	<select id="selectSearchPatientNameAndDateList"  resultType="receiptAndOpinions">
		select r.receipt_id, date_format(receipt_datetime, '%Y-%m-%d') as receipt_datetime, r.receipt_state, r.diagnostic_test_state, r.receipt_opinion, r.receipt_uniqueness, r.patient_id
		from receipt_and_opinions r, patients p
		where r.patient_id = p.patient_id and receipt_datetime Like CONCAT('%', #{receipt_datetime}, '%') and p.patient_name = #{patient_name}
	</select>
	
	<select id="selectSearchAllList"  resultType="receiptAndOpinions">
		select r.receipt_id, date_format(receipt_datetime, '%Y-%m-%d') as receipt_datetime, r.receipt_state, r.diagnostic_test_state, r.receipt_opinion, r.receipt_uniqueness, r.patient_id
		from receipt_and_opinions r, patients p
		where r.patient_id = p.patient_id and receipt_datetime Like CONCAT('%', #{receipt_datetime}, '%') and p.patient_name = #{patient_name} and r.patient_id = #{patient_id}
	</select>
	
	<update id="updateReceiptState">
		update receipt_and_opinions
		set receipt_state = '검사중', diagnostic_test_state='검사대기', receipt_opinion='검사 완료 후 소견 작성 필요'
		where receipt_id = #{receipt_id}
	</update>
	
	<select id="selectFatientOpinionsList" resultType="receiptAndOpinions">
		select receipt_id, date_format(receipt_datetime, '%Y-%m-%d') as receipt_datetime, receipt_state, diagnostic_test_state, receipt_opinion, receipt_uniqueness, patient_id
		from receipt_and_opinions
		where patient_id = #{patient_id}
		order by receipt_id DESC
	</select>
	
	<update id="updateInsertOpinion">
		update receipt_and_opinions
		set receipt_opinion = #{receipt_opinion}, receipt_uniqueness = #{receipt_uniqueness}, receipt_state = '수납전'
		where receipt_id = #{receipt_id}
	</update>
	
	<select id="selectPatientStateList" parameterType="string" resultType="receiptAndOpinions">
		select distinct rao.receipt_id, rao.receipt_state, rao.diagnostic_test_state, p.patient_id, p.patient_name, p.patient_sex, 
		cast(date_format(now(), '%Y') as unsigned) - cast(case 
			when substring(patient_ssn, 8, 1) in ('1', '2', '5', '6') then '1900' + substring(patient_ssn, 1, 2)
			when substring(patient_ssn, 8, 1) in ('3', '4', '7', '8') then '2000' + substring(patient_ssn, 1, 2)
			end as unsigned) + 1 as patient_age  
		<if test="type == '전체'">
			from receipt_and_opinions as rao, patients as p
			where rao.patient_id = p.patient_id and receipt_state = '검사중'
		</if>
		<if test="type != '전체'">
			from receipt_and_opinions as rao, diagnostic_lists as dl, searchs as s, bundles as b, patients as p
			where rao.receipt_id = dl.receipt_id and dl.search_id = s.search_id and s.bundle_id = b.bundle_id and b.bundle_lab = #{type} and rao.patient_id = p.patient_id
		</if>
		<if test="state == 'whole'">
			and diagnostic_test_state != '검사완료'
		</if>
		<if test="state != 'whole'">
			and diagnostic_test_state = #{state}
		</if>
	</select>
	
</mapper>
